# TOPIC XX: DISTRIBUTED SERVICES Ⅳ——Spring Cloud & Microservice Architecture
  
## 1. 微服务架构发展历程与应用场景：45'19''
### 发展历程
* IT 发展历程
    * 电子化信息化：从线下到线上
    * 网络化移动化：移动设备的普及，数据的互联互通
    * 数字化智能化：数字定量分析，技术推动业务
* 需求发展：业务复杂度上升、数据量上升，系统对性能、稳定性、可用性、扩展性、可维护性要求越来越高。
* 架构发展
    * 单体架构
        * 分工协作有影响
    * 垂直架构 
        * 横向分层：结构化思考 + 抽象聚合
        * 纵向按业务模块和功能垂直拆分
        * 协作研发
        * 关注：单个系统
        * 例：MVC，常见的3层结构架构模式
    * SOA (Service-Oriented Architecture) 架构
        * 建设企业 IT 生态系统的架构指导思想
        * 关注点：服务（最基本的业务功能单元）
        * 由平台中立性的接口契约（Service Contract）来定义
    * 微服务架构 MSA
        * 开发一个应用系统：实现一组微服务；每个微服务运行在自己的进程中，是一套完整自洽的小系统
        * 轻量机制通信：通过 HTTP 资源 API 调用（RESTful API）
        * 架构：客户端 -> 网关（策略控制） -> 微服务（之间用服务接口相互调用；注册到注册中心）

* 微服务发展历程
    * 发展趋势：响应式微服务 -> 服务网格 -> 数据库网格 -> 云原生 -> 单元化架构
    * 方向一：响应式微服务 MicroService
        * 响应式编程：专注于数据流和变化传递的`异步`编程范式
            * 响应式宣言：即时响应性（一定有响应），可恢复性（回弹性），弹性（扩展性，伸缩性），消息驱动（异步）
        * 特点一：自治性，每个微服务隔离，异常自处理、不扩散
        * 特点二：异步性
        * 特点三：伸缩性
        * 特点四：回弹性
    * 方向二：服务网格 ServiceMesh & 云原生 Cloud-Native
        * 服务网格：将服务间的网络通信层及其控制策略下沉到基础设施
            * 服务间通过 Sidecar（由 ControlPanel 统一管理分发和控制） 通信串联
        * 云原生体系：微服务、容器化、持续交付、DevOps 等技术组成
    * 方向三：数据库网格 DatabaseMesh
        * 参考服务网格的实现，节点间通过 Sidecar 连接数据库（由 ControlPanel 统一管理分发和控制）
        * Level 1：MySQL 数据库提供的能力
        * Level 2：Sharding-JDBC 框架（1.x+）
        * Level 3：Sharding-Proxy 中间件（3.x+）
        * Level 4：Sharding-Scaling（4.x+）
        * Level 5：Sharding-Sidecar（5.x+）
        * Level 6：Sharding-Engine（6.x+）
    * 方向四：单元化架构 Cell Architecture
        * 以单元为组织架构————功能应用全量（部署了多个层级的不同的应用系统），数据不全量；单元是容量、部署、容灾、高可用的基本单元
        * 以单元化部署为调度单位————系统可以部署在多个机房
        * 在业务入口处设置流量适配器，调整业务流量在单元间的比例。

### 应用场景
* 场景：复杂度高
    * 复杂度较低时，单体架构生产力较高
    * 微服务架构适用于大规模复杂业务系统的架构升级与中台建设（生产力平稳的优势）
        * 前台（不同业务形态）：业务线
        * 中台（通用）：API 接入层，业务中台（可复用的微服务能力），技术中台（微服务体系和中间件）；数据中台，管理中台，组织中台
        * 后台：基础设施
* 如何应用与落地？
    * `准备阶段：调研I -> 分析A -> 规划P -> 组织O`
        * 确认微服务改造的期望与切入方式
        * 30% - 40%
    * `实施阶段：拆分S -> 部署D -> 治理G -> 改进I`
    * 循环往复：调研I -> 分析A -> 规划P -> 组织O -> 拆分S -> 部署D -> 治理G -> 改进I -> 调研I -> ......


## 2. 微服务架构最佳实践：39'37''
### 最佳实践一：遗留系统改造
* 功能剥离，数据解耦
    * 部分功能从单体模块逐渐剥离
    * 从上到下：应用层面的数据解耦、SQL解耦、数据库库表解耦
* 自然演进，逐步拆分
    * 平衡短期的直接业务价值与长期的系统可维护性，找到痛点首先改革推进、逐步拆分
* 小步快跑，谨慎迭代
    * 长期的改造过程，阶段性成果
* 灰度发布，谨慎试错
    * 灰度环境下先验证，最后全线验证
* 提质量线，还技术债
    * 系统在不断 feat feature / fix bug 的过程中质量下降，借机可以重新提升质量线

### 最佳实践二：恰当粒度拆分
* 拆分原则（暂无标准拆分手段）
    1. `高内聚，低耦合`   
        * 工具：DDD
    2. 不同阶段，不同拆分要点
        * 一步到位的拆分整体消耗很大，需要研发能力很高
        * 先拆分风险高的部分，容易推动

### 最佳实践三：扩展立方体（AFK）
* 扩展立方体
    * x-axis: 水平复制（复制系统；例，集群）
    * Y-axis: 功能解耦（拆分业务，按不同访问频率拆分，分别扩展节点；例，用户系统 & 订单系统）
    * Z-axis: 数据分区（切分数据，一类数据；例，DB 的分库分表，普通用户与VIP用户）
* 单元化架构的基础
    * 不仅仅是分库分表、集群、微服务拆分的扩展指导思想
* 注：非水平类的扩展（功能解耦/数据分区），都对老的业务系统具有侵入性，导致“新老兼容问题”
    * solution 1: 增加`特性开关`（新老系统同时上线，出现问题后无需重启，关闭开关；在灰度环境试错都没有问题后，可以完全打开特性开关，接受流量，稳定运行一段时间，在下一次上线时替换老功能，去掉开关）
    * solution 2: 增加容错设计（预处理外部错误不会影响微服务模块）

### 最佳实践四：自动化管理
* 微服务拆分带来的复杂度
    * 测试、部署、运维更复杂，对研发团队的成熟度要求提高
* 自动化管理，降低人工干预
    * 自动化测试，自动化部署，自动化运维
* 好处
    * 降低服务拆分带来的复杂性
    * 提升测试、部署、运维的效率

### 最佳实践五：分布式事务
* 建议少用分布式事务！！！
* 原因：每个微服务相对粒度较小，每个微服务独立发展、运行、演进
    * 充分利用微服务的生产效率
    * 学习单个微服务的成本相对较低
    * 每个微服务的变更（不影响中间接口）不影响其他微服务
    * 若套用分布式事务，微服务间有了总体状态，对各自的独立发展产生约束
* 建议
    * 根据业务设计尽量避免分布式事务，使各微服务操作的数据天然隔离
    * 补偿冲正：撤销当前的事务操作对业务/数据库的影响
        * 幂等/去重：考虑重复性操作

### 最佳实践六：完善监控体系
* 监控体系
    * `业务监控`：优先看业务指标，有问题时针对异常现象去找对应的技术指标
    * `系统监控`（例，CPU，内存使用量，GC程度，网络抖动，延迟等）
    * 容量规划
        * 性能、稳定性、可用性
        * 方式：性能基线压测，or，相同性能、相同网络、相同配置、相同脱敏数据的测试环境，or，线上压测，“影子压测” 等
        * 作用：估算未来需要的容量，促进系统本身的改进
    * 报警预警（设置不同水位，快速采取措施干预未来的崩溃）
    * 运维流程（`大规模的分布式项目一定要有标准的运维发布部署上线变更流程`）
    * 故障处理（积累故障，做 COE 根因分析，便于后续重新规划）
        * 天灾：需要充分的应急机制，各团队间完善的协调机制。
        * 人祸：教育不听话的人。
        * 超出团队知识储备和能力的：组织买单，通过复盘根因分析转换成组织吸收的经验知识。
        * 避免事故：故障处理前通知用户，使其有预期去操作。
* “稳定性建设”
* 辅助的研发策略：
    * DevOps：开发人员同时负责业务相关的运维（版本的发布上线），运维人员作为 SRE 工程师保障系统基础设施的稳定性。
    * SRE


## 3. Spring Cloud 技术体系/微服务相关框架与工具：29'44''
### Spring Cloud 技术体系
* Spring Cloud 生态里有很多组件
* 微服务架构调用关系简图 + Spring Cloud + 第三方组件
    * 请求：用户请求 --> 服务网关 --> Ribbon 负载均衡 --> microservices
    * 服务注册发现：microservice <--> Eureka <--> 服务网关
    * 配置：Spring Cloud Cdonfig / Apollo --> microservices & 服务网关
    * 服务网关 --> Hystrix 容错限流
    * 服务网关 --> Spring Security / Shiro / OAuth2 授权认证中心
    * 微服务外部
        * 调用链监控：便于优化跨微服务节点的调用
        * Metrics 监控
        * 日志监控（由 Kafka 统一收集处理信息）
        * 健康检查和告警

### 常用组件
* 配置 & 注册：Config / Eureka / Consul
    * Config 配置中心：使用 Git Server 作为配置的数据来源，Config Server 拉取远程 git 仓库中的配置信息，分发给各微服务节点。
    * Eureka 注册发现：集群中部署3个 Eureka 节点（对等节点），服务提供者 register / renew（发生变化时） / cancel（下线时） 信息到 Eureka server；服务消费者从 Eureka server 中 get registry，再通过远程调用访问具体的服务提供者。
    * Consul 配置、服务注册发现

* 网关：Zuul / Zuul2 / Spring Cloud Gateway 
    * Zuul：基于 BIO
    * Zuul2：基于 Netty，使用 NIO 技术
    * Spring Cloud Gateway：基于 Spring5 的响应式编程
    * 结构：请求 --> pre filters --> routing filters --> origin server（拿到响应） --> post filters --> 原始调用方

* Feign / Ribbon 
    * Feign 作为 HTTP client，访问 REST 服务接口（RESTful 接口的 RPC 封装，封装远程的 RESTful 接口变成本地的RPC调用）
        * 优势一：全部基于注解
        * 优势二：内置了简化的面向对象的操作，OOP
        * 优势三：与其他组件（Ribbon, Hystrix）联合使用
    * Ribbon 适用于云环境的一个客户端内部通信（IPC）库。
        * 特性一：`负载均衡`（主要功能）
        * 特性二：容错
        * 特性三：多协议（HTTP/TCP/UDP）支持，特别是异步和反应式下
        * 特性四：缓存和批处理

* Hystrix / Alibaba Sentinel / Reslient4j
    * Hystrix 熔断、限流
    * Alibaba Sentinel：三大功能（限流、服务降级、过载保护；以资源为核心的设计）
    * Reslient4j：开源

### 微服务相关框架与工具
* APM (Application Performance Monitor) 应用性能监控：全链路监控工具，全链路跟踪
    * 开源产品：Apache Skywalking, Pinpoint, Zipkin, Jaeger
        * Apache Skywalking：云原生中可观测性的工具/解决方案
    * 监控：ELK (Logstash 收集日志，ElasticSearch 查询分析日志，Kibana 展示日志)，promethus（自定义的监控指标，指标度量的埋点打入 promethus） + Grafana（定义可视化图表）, MQ + 时序DB（InfluxDb . openTSDB 等）
    * 可观测性：logging, tracing, Metrics 指标的度量和健监控
    * 标准：OpenTracing（老牌）, OpenSensus, OPenTelemetry（统一方案）

* 权限控制
    * 3A: Authc (Authentication), Authz (Authorization), Audit 审计（事前事中事后）
    * 统一的身份认证 & 登录：CAS + SSO (TGT-token 登录完获得, ST-service token 用于访问具体业务)
    * 权限管理控制框架：SpringSecurity, Apache Shiro

* 数据处理

* 网关与通信
    * 流量网关 & WAF
        * 流量网关：Nginx, OpenResty, Kong, Apisix
        * WAF：web应用的防火墙
    * 业务网关：Zuul/Zuul2/SCG/Soul
    * REST（易用）与其他协议（性能稍好，但可维护性较低）
        * websocket：借助 HTTP 底层的 TCP 通道通信
        * rsocket：底层可切换 TCP/UDP
        * actor / mq 等
